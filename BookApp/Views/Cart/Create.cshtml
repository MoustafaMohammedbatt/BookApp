@model Shared.DTOs.CartCreateDTO

@{
    ViewData["Title"] = "Create Cart";
}

<h1>Create Cart</h1>

<form asp-action="Create">
    <div class="form-group">
        <label for="userEmail">User Email</label>
        <input id="userEmail" name="UserEmail" class="form-control" />
        <div id="userResults" class="dropdown-menu"></div> <!-- Dropdown to show search results -->
        <input type="hidden" id="selectedUserId" name="UserId" /> <!-- Hidden input to store selected UserId -->
        <span asp-validation-for="UserEmail" class="text-danger"></span>
    </div>
    <div class="form-group">
        <input type="submit" value="Create" class="btn btn-primary" />
    </div>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#userEmail').on('input', function () {
                var email = $(this).val();
                if (email.length >= 1) { // Start search after typing at least 3 characters
                    $.ajax({
                        url: '@Url.Action("SearchUsers")', // Calls the SearchUsers action
                        type: 'GET',
                        data: { email: email },
                        success: function (data) {
                            var resultsHtml = '';
                            data.forEach(function (user) {
                                resultsHtml += '<div class="user-result dropdown-item" data-id="' + user.id + '">' + user.email + '</div>';
                            });
                            $('#userResults').html(resultsHtml).show(); // Display results in dropdown
                        }
                    });
                } else {
                    $('#userResults').hide(); // Hide results if input length is less than 3
                }
            });

            $(document).on('click', '.user-result', function () {
                var userId = $(this).data('id');
                var userEmail = $(this).text();
                $('#userEmail').val(userEmail); // Set selected email in input
                $('#selectedUserId').val(userId); // Store selected user ID in hidden field
                $('#userResults').hide(); // Hide dropdown after selection
            });

            // Hide the dropdown when clicking outside of it
            $(document).on('click', function (e) {
                if (!$(e.target).closest('#userEmail, #userResults').length) {
                    $('#userResults').hide();
                }
            });
        });
    </script>
}
